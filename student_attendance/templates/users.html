{% extends 'base.html' %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-6 space-y-2">
      {% for category, message in messages %}
        <div class="p-4 rounded-xl border flex items-center shadow-sm 
            {% if category == 'success' %} bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800 
            {% else %} bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border-red-200 dark:border-red-800 {% endif %}">
            <span class="font-bold">{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">User Management</h2>
    <p class="text-gray-500 dark:text-slate-400 text-sm">Create and manage admin accounts.</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    
    <!-- ADD USER FORM -->
    <div class="bg-white dark:bg-dark-surface rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6 h-fit">
        <h5 class="font-bold text-gray-800 dark:text-white mb-4 text-lg">Add New User</h5>
        <form action="{{ url_for('add_user') }}" method="POST" id="addUserForm">
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">Username</label>
                <input type="text" name="username" required class="w-full border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">Password</label>
                <input type="password" name="password" required class="w-full border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-1">Role</label>
                <select name="role" id="roleSelect" onchange="togglePermissions(this.value)" class="w-full border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="sub_admin">Sub-Admin (Restricted)</option>
                    <option value="admin">Super Admin (Full Access)</option>
                </select>
            </div>

            <!-- PERMISSIONS CHECKBOXES (Hidden for Super Admin) -->
            <div id="permissionsArea" class="mb-6 p-4 bg-gray-50 dark:bg-slate-800/50 rounded-lg border border-gray-200 dark:border-slate-600">
                <p class="text-xs font-bold text-gray-500 dark:text-slate-400 uppercase mb-2">Sub-Admin Privileges</p>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="perm_settings" class="accent-primary w-4 h-4">
                        <span class="text-sm text-gray-700 dark:text-slate-300">Access Settings (Grades/Sections)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="perm_backup" class="accent-primary w-4 h-4">
                        <span class="text-sm text-gray-700 dark:text-slate-300">System Backup & Restore</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="perm_archive" class="accent-primary w-4 h-4">
                        <span class="text-sm text-gray-700 dark:text-slate-300">Manage Archive (Delete/Restore)</span>
                    </label>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700 transition shadow-md">Create User</button>
        </form>
    </div>

    <!-- USER LIST -->
    <div class="bg-white dark:bg-dark-surface rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
        <div class="bg-gray-50 dark:bg-slate-800 px-6 py-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
            <h5 class="font-bold text-gray-800 dark:text-white">Existing Users</h5>
            <span class="text-xs font-bold bg-white dark:bg-slate-700 dark:text-slate-300 px-2 py-1 rounded border border-gray-200 dark:border-slate-600">{{ users|length }} Users</span>
        </div>
        <ul class="divide-y divide-gray-100 dark:divide-slate-700">
            {% for user in users %}
            <li class="px-6 py-4 flex flex-col gap-2 hover:bg-gray-50 dark:hover:bg-slate-800/50 transition">
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-900 dark:text-white">{{ user.username }}</span>
                        {% if user.role == 'admin' %}
                            <span class="bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 text-[10px] px-2 py-0.5 rounded-full font-bold">Super Admin</span>
                        {% else %}
                            <span class="bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-[10px] px-2 py-0.5 rounded-full font-bold">Sub-Admin</span>
                        {% endif %}
                    </div>
                    {% if user.username != session.get('username') %}
                        <a href="{{ url_for('delete_user', user_id=user.id) }}" class="text-red-400 hover:text-red-600 dark:hover:text-red-400 p-1" onclick="return confirm('Delete?')"><i class="ri-delete-bin-fill"></i></a>
                    {% endif %}
                </div>

                <!-- Show Privileges Badges -->
                {% if user.role != 'admin' %}
                <div class="flex gap-2 mt-1">
                    <span class="text-[10px] px-2 rounded border {{ 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400' if user.can_settings else 'bg-gray-100 text-gray-400 border-gray-200 dark:bg-slate-800 dark:border-slate-700' }}">Settings</span>
                    <span class="text-[10px] px-2 rounded border {{ 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400' if user.can_backup else 'bg-gray-100 text-gray-400 border-gray-200 dark:bg-slate-800 dark:border-slate-700' }}">Backup</span>
                    <span class="text-[10px] px-2 rounded border {{ 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400' if user.can_archive else 'bg-gray-100 text-gray-400 border-gray-200 dark:bg-slate-800 dark:border-slate-700' }}">Archive</span>
                    
                    <button onclick="openPermModal('{{ user.id }}', '{{ user.username }}', {{ 'true' if user.can_settings else 'false' }}, {{ 'true' if user.can_backup else 'false' }}, {{ 'true' if user.can_archive else 'false' }})" class="text-[10px] text-blue-500 hover:underline ml-auto font-bold">Edit</button>
                </div>
                {% endif %}
                
                <div class="mt-2">
                    <button onclick="openPassModal('{{ user.id }}', '{{ user.username }}')" class="text-xs text-gray-500 hover:text-blue-500 underline">Change Password</button>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div id="passwordModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95 opacity-0 transition-all duration-200" id="passModalContent">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Reset Password</h3>
        <p class="text-sm text-gray-500 dark:text-slate-400 mb-4">Set a new password for <span id="passModalUser" class="font-bold text-gray-800 dark:text-white"></span>.</p>
        <form id="passForm" method="POST">
            <input type="password" name="new_password" placeholder="New Password" required class="w-full border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-gray-900 dark:text-white rounded-lg px-3 py-2 mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closePassModal()" class="px-4 py-2 text-gray-600 dark:text-slate-400 font-bold hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT PERMISSIONS MODAL -->
<div id="permModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95 opacity-0 transition-all duration-200" id="permModalContent">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Edit Permissions</h3>
        <p class="text-sm text-gray-500 dark:text-slate-400 mb-4">Update access for <span id="permModalUser" class="font-bold text-gray-800 dark:text-white"></span>.</p>
        <form id="permForm" method="POST">
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="perm_settings" id="chkSettings" class="accent-primary w-4 h-4">
                    <span class="text-sm text-gray-700 dark:text-slate-300">Access Settings</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="perm_backup" id="chkBackup" class="accent-primary w-4 h-4">
                    <span class="text-sm text-gray-700 dark:text-slate-300">System Backup & Restore</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="perm_archive" id="chkArchive" class="accent-primary w-4 h-4">
                    <span class="text-sm text-gray-700 dark:text-slate-300">Manage Archive</span>
                </label>
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closePermModal()" class="px-4 py-2 text-gray-600 dark:text-slate-400 font-bold hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    function togglePermissions(role) {
        const area = document.getElementById('permissionsArea');
        if (role === 'admin') area.classList.add('hidden');
        else area.classList.remove('hidden');
    }

    // Password Modal Logic
    const passModal = document.getElementById('passwordModal');
    const passContent = document.getElementById('passModalContent');
    function openPassModal(userId, username) {
        document.getElementById('passForm').action = `/users/change_password/${userId}`;
        document.getElementById('passModalUser').innerText = username;
        passModal.classList.remove('hidden');
        setTimeout(() => { passContent.classList.remove('scale-95', 'opacity-0'); passContent.classList.add('scale-100', 'opacity-100'); }, 10);
    }
    function closePassModal() {
        passContent.classList.remove('scale-100', 'opacity-100'); passContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => { passModal.classList.add('hidden'); }, 200);
    }

    // Permissions Modal Logic
    const permModal = document.getElementById('permModal');
    const permContent = document.getElementById('permModalContent');
    function openPermModal(userId, username, s, b, a) {
        document.getElementById('permForm').action = `/users/update_permissions/${userId}`;
        document.getElementById('permModalUser').innerText = username;
        document.getElementById('chkSettings').checked = s;
        document.getElementById('chkBackup').checked = b;
        document.getElementById('chkArchive').checked = a;
        permModal.classList.remove('hidden');
        setTimeout(() => { permContent.classList.remove('scale-95', 'opacity-0'); permContent.classList.add('scale-100', 'opacity-100'); }, 10);
    }
    function closePermModal() {
        permContent.classList.remove('scale-100', 'opacity-100'); permContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => { permModal.classList.add('hidden'); }, 200);
    }
</script>
{% endblock %}